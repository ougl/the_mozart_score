<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Townsendâ€™s Heavy Network</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background:
        radial-gradient(1200px 700px at 18% 10%, rgba(244,63,94,0.10), transparent 55%),
        radial-gradient(1000px 600px at 80% 20%, rgba(249,115,22,0.10), transparent 58%),
        radial-gradient(circle at center, #070b18 0%, #01020a 65%, #000 100%);
      color: #f8fafc;
      overflow: hidden;
      font-family: 'serif', system-ui, sans-serif;
    }

    .ambient-glow {
      position: absolute;
      width: 100vw;
      height: 100vh;
      background:
        radial-gradient(circle at 50% 45%, rgba(249,115,22,0.06) 0%, transparent 70%),
        radial-gradient(circle at 30% 65%, rgba(244,63,94,0.05) 0%, transparent 72%);
      pointer-events: none;
    }

    .node circle {
      stroke-width: 1px;
      transition: opacity 0.8s ease, filter 0.3s ease;
      cursor: pointer;
    }

    .node:hover circle {
      filter: brightness(1.35) drop-shadow(0 0 10px rgba(249,115,22,0.20)) drop-shadow(0 0 14px rgba(244,63,94,0.16));
    }

    .node.selected circle {
      stroke: rgba(255,255,255,0.92);
      stroke-width: 2px;
      filter: drop-shadow(0 0 18px rgba(249,115,22,0.24)) drop-shadow(0 0 28px rgba(244,63,94,0.18));
    }

    .link-container { cursor: pointer; }

    .link-bg {
      fill: none;
      stroke: transparent;
      stroke-width: 14px;
    }

    /* âœ… thinner + more transparent by default for readability */
    .link-main {
      fill: none;
      stroke-width: 1.35px;
      stroke-opacity: 0.14;
      transition: stroke-opacity 0.6s ease, stroke-width 0.6s ease, filter 0.6s ease;
      pointer-events: none;
    }

    .link-container:hover .link-main {
      stroke-opacity: 0.55;
      stroke-width: 1.8px;
      stroke: rgba(255,255,255,0.92);
      filter: drop-shadow(0 0 10px rgba(255,255,255,0.10));
    }

    .label {
      font-size: 9px;
      font-family: 'serif';
      font-style: italic;
      fill: rgba(255,255,255,0.4);
      letter-spacing: 0.12em;
      pointer-events: none;
      transition: fill 0.8s ease;
    }

    .node.selected .label { fill: rgba(255,255,255,1); font-size: 10px; }

    /* âœ… Link label on arc */
    .link-label {
      font-size: 8px;
      font-family: 'serif';
      font-style: italic;
      fill: rgba(255,255,255,0.42);
      letter-spacing: 0.14em;
      text-transform: uppercase;
      pointer-events: none;
      user-select: none;
    }
    .link-container:hover .link-label{
      fill: rgba(255,255,255,0.85);
    }

    #bio-card {
      position: absolute;
      top: 40px;
      right: 40px;
      width: 340px;
      background: rgba(2, 6, 23, 0.6);
      backdrop-filter: blur(25px);
      border-left: 1px solid rgba(255, 255, 255, 0.1);
      display: none;
      z-index: 100;
      padding: 30px 25px;
    }

    .bio-header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 25px;
    }

    #bio-image {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      object-fit: cover;
      filter: grayscale(0.2);
      border: 1px solid rgba(255,255,255,0.15);
      flex-shrink: 0;
    }

    #bio-name { margin-bottom: 4px; }

    #music-player {
      position: absolute;
      bottom: 40px;
      left: 40px;
      background: transparent;
      display: none;
      z-index: 100;
    }

    .timeline-axis { stroke: rgba(255,255,255,0.05); stroke-dasharray: 4; }
    .timeline-label { fill: rgba(255,255,255,0.15); font-size: 14px; font-family: serif; font-style: italic; }

    #legend {
      position: absolute;
      bottom: 40px;
      right: 40px;
      display: flex;
      gap: 20px;
      opacity: 0.5;
      transition: opacity 0.5s;
      z-index: 120;
      pointer-events: auto;
    }
    #legend:hover { opacity: 1; }

    .legend-item { display: flex; align-items: center; gap: 8px; font-size: 9px; text-transform: uppercase; letter-spacing: 0.1em; color: #94a3b8; }
    .legend-color { width: 7px; height: 7px; border-radius: 50%; box-shadow: 0 0 5px currentColor; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .fade-in { animation: fadeIn 2s ease-out; }

    #audio-progress{ background: linear-gradient(90deg, rgba(249,115,22,0.55), rgba(244,63,94,0.45), rgba(255,255,255,0.35)); }

    /* ---------------- Search UI ---------------- */
    #search-wrap{
      position: absolute;
      top: 24px;
      left: 24px;
      z-index: 150;
      width: min(460px, calc(100vw - 48px));
    }
    #search-input{
      width: 100%;
      background:
        radial-gradient(800px 240px at 10% 0%, rgba(249,115,22,0.10), transparent 65%),
        rgba(2, 6, 23, 0.55);
      backdrop-filter: blur(18px);
      border: 1px solid rgba(255,255,255,0.10);
      color: rgba(255,255,255,0.85);
      border-radius: 999px;
      padding: 10px 14px;
      font-size: 12px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      outline: none;
      flex: 1;
    }
    #search-input::placeholder{ color: rgba(255,255,255,0.25); }
    #search-results{
      margin-top: 10px;
      background:
        radial-gradient(900px 260px at 90% 0%, rgba(244,63,94,0.10), transparent 60%),
        rgba(2, 6, 23, 0.62);
      backdrop-filter: blur(18px);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 16px;
      overflow: hidden;
      display: none;
    }
    .sr-item{
      padding: 10px 12px;
      font-size: 12px;
      color: rgba(255,255,255,0.75);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: baseline;
    }
    .sr-item small{ color: rgba(255,255,255,0.25); font-size: 10px; letter-spacing: 0.12em; text-transform: uppercase;}
    .sr-item:hover, .sr-item.active{ background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.95); }

    /* ---------------- Responsive ---------------- */
    @media (max-width: 900px){
      #legend{ right: 18px; bottom: 18px; gap: 14px; }
      #music-player{ left: 18px; bottom: 18px; }
      #bio-card{ right: 18px; top: 18px; width: min(340px, calc(100vw - 36px)); }
      #search-wrap{ top: 18px; left: 18px; width: min(520px, calc(100vw - 36px)); }
    }
    @media (max-width: 640px){
      body{ overflow: hidden; }
      #legend{ display: none; }
      #music-player{ left: 12px; bottom: 12px; }
      #bio-card{
        left: 12px;
        right: 12px;
        top: auto;
        bottom: 12px;
        width: auto;
        max-height: 46vh;
        padding: 18px 16px;
        border-left: 0;
        border-top: 1px solid rgba(255,255,255,0.10);
      }
      #bio-desc{ max-height: 24vh; }
      #search-wrap{ top: 12px; left: 12px; width: calc(100vw - 24px); }
    }

    /* Overlay always on top */
    #overlay{
      position: fixed;
      inset: 0;
      z-index: 2000;
      pointer-events: auto;
    }

    body.overlay-open #viz,
    body.overlay-open #viz * {
      pointer-events: none !important;
    }

    body.overlay-open #overlay,
    body.overlay-open #overlay * {
      pointer-events: auto !important;
    }

    #start-btn{
      z-index: 2001;
      pointer-events: auto;
      touch-action: manipulation;
    }

    #viz{ position: relative; z-index: 1; }
    svg{ touch-action: none; }

    .search-row{ display:flex; align-items:center; gap:10px; }

    #music-switch{
      width: 42px; height: 42px; flex-shrink: 0;
      display:flex; align-items:center; justify-content:center;
      border-radius:14px;
      background:
            radial-gradient(800px 240px at 10% 0%, rgba(249,115,22,0.10), transparent 65%),
            rgba(2, 6, 23, 0.55);
      backdrop-filter: blur(18px);
      border: 1px solid rgba(255,255,255,0.10);
      color: rgba(255,255,255,0.65);
      font-size: 16px;
      text-decoration: none;
      transition: all 0.35s ease;
    }

    #music-switch:hover{
      transform: scale(1.08);
      border-color: rgba(255,255,255,0.35);
      color: white;
      box-shadow: 0 0 18px rgba(249,115,22,0.16), 0 0 30px rgba(244,63,94,0.10);
    }

    .metal-noise{
      position: fixed; inset: 0; pointer-events: none; z-index: 5;
      opacity: .07; mix-blend-mode: overlay;
      background-image:
        repeating-linear-gradient(0deg, rgba(255,255,255,.04) 0 1px, transparent 1px 4px),
        repeating-linear-gradient(90deg, rgba(255,255,255,.02) 0 1px, transparent 1px 6px);
    }

    .flame-kitsch{
      position: fixed; left: 0; right: 0; bottom: 0; height: 42vh;
      pointer-events: none; z-index: 7;
      opacity: .9; mix-blend-mode: screen;
      will-change: transform, opacity; transform: translateZ(0);
    }

    .flame-kitsch::before{
      content:"";
      position:absolute; inset: -10% -6% 0 -6%;
      background:
        radial-gradient(60px 100px at 10% 100%, rgba(255,120,0,.55), transparent 62%),
        radial-gradient(80px 120px at 20% 100%, rgba(255,40,120,.45), transparent 63%),
        radial-gradient(70px 110px at 32% 100%, rgba(255,200,0,.42), transparent 62%),
        radial-gradient(90px 140px at 48% 100%, rgba(255,90,0,.50), transparent 64%),
        radial-gradient(75px 120px at 62% 100%, rgba(255,40,120,.40), transparent 64%),
        radial-gradient(95px 150px at 78% 100%, rgba(255,140,0,.48), transparent 66%),
        radial-gradient(70px 120px at 90% 100%, rgba(255,200,0,.40), transparent 64%);
      animation: kitschFlame 1.2s steps(3) infinite;
      transform-origin: bottom center;
    }

    @keyframes kitschFlame{
      0%   { transform: translateY(10px) scaleY(0.98) skewX(-2deg); opacity:.75; }
      33%  { transform: translateY(-6px) scaleY(1.03) skewX(2deg); opacity:.95; }
      66%  { transform: translateY(4px) scaleY(1.00) skewX(-1deg); opacity:.85; }
      100% { transform: translateY(10px) scaleY(0.98) skewX(-2deg); opacity:.75; }
    }

    .sparkles{
      position: fixed; inset: 0; pointer-events: none; z-index: 8;
      opacity: .55;
      background:
        radial-gradient(1.5px 1.5px at 12% 78%, rgba(255,255,255,.75), transparent 60%),
        radial-gradient(1.5px 1.5px at 22% 82%, rgba(255,255,255,.65), transparent 60%),
        radial-gradient(1.5px 1.5px at 38% 80%, rgba(255,255,255,.70), transparent 60%),
        radial-gradient(1.5px 1.5px at 55% 84%, rgba(255,255,255,.60), transparent 60%),
        radial-gradient(1.5px 1.5px at 72% 79%, rgba(255,255,255,.70), transparent 60%),
        radial-gradient(1.5px 1.5px at 88% 83%, rgba(255,255,255,.65), transparent 60%);
      animation: sparkleFloat 2.2s linear infinite;
      will-change: transform, opacity;
    }

    @keyframes sparkleFloat{
      0%   { transform: translateY(0); opacity:.25; }
      30%  { opacity:.65; }
      100% { transform: translateY(-60px); opacity:0; }
    }

    .kitsch-stickers{
      position: fixed; left: 16px; bottom: 16px; z-index: 110;
      pointer-events: none; opacity: .55;
      font-size: 18px; letter-spacing: 6px; user-select: none;
    }

    @media (prefers-reduced-motion: reduce){
      .flame-kitsch::before, .sparkles { animation: none !important; }
    }
  </style>
</head>

<body class="overlay-open">
  <div class="ambient-glow"></div>
  <div class="metal-noise"></div>
  <div class="flame-kitsch"></div>
  <div class="sparkles"></div>
  <div class="kitsch-stickers">ðŸ”¥ ðŸ¤˜ ðŸ”¥ ðŸ¤˜ ðŸ”¥</div>

  <div id="search-wrap" class="fade-in">
    <div class="search-row">
     <a href="./index.html" id="music-switch"
        title="Voyage vers Mozart">
        ðŸŽ¼
      </a>
    <a href="./jazz_swing.html" id="music-switch"
        title="Voyage vers Ray Charles">
        ðŸŽ·
      </a>
      <input id="search-input" type="text" autocomplete="off" spellcheck="false"
        placeholder="Rechercher un nÅ“udâ€¦ (ex: Townsend, Julio Iglesias :) ...)"/>
    </div>
    <div id="search-results" aria-label="RÃ©sultats de recherche"></div>
  </div>

  <div id="overlay" class="fixed inset-0 bg-slate-950 flex flex-col items-center justify-center z-[2000] transition-opacity duration-[2000ms]">
    <h1 class="text-4xl font-serif italic text-white/80 mb-2 tracking-[0.2em]">Townsend's Heavy Network</h1>
    <button id="start-btn" class="px-12 py-3 border border-white/10 rounded-full text-white/50 text-[10px] tracking-[0.3em] uppercase hover:border-white/40 hover:text-white transition-all duration-700">
      Lancer le riff ðŸ”¥
    </button>
    <p id="load-status" class="mt-8 text-[10px] tracking-[0.2em] text-white/20 uppercase"></p>
  </div>

  <div id="bio-card" class="fade-in">
    <div class="bio-header">
      <img id="bio-image" src="" alt="Portrait" onerror="this.style.display='none'">
      <div class="flex flex-col justify-center">
        <h2 id="bio-name" class="text-lg font-serif italic text-white/90"></h2>
        <div id="bio-dates" class="text-[9px] tracking-[0.2em] text-white/30 uppercase"></div>
      </div>
    </div>

    <p id="bio-desc" class="text-xs text-white/50 leading-relaxed font-light mb-8 max-h-60 overflow-y-auto pr-4 italic"></p>

    <div class="flex justify-end">
      <button onclick="document.getElementById('bio-card').style.display='none'"
        class="text-[9px] uppercase tracking-widest text-white/20 hover:text-white transition-colors">
        Fermer
      </button>
    </div>
  </div>

  <div id="music-player">
    <div class="flex flex-col gap-1">
      <p id="player-track" class="text-[10px] italic text-white/40 font-light"></p>
      <p id="player-role" class="text-[9px] uppercase tracking-[0.2em] text-white/25"></p>

      <div class="flex items-center gap-4">
        <button id="play-pause-btn" class="text-white/60 hover:text-white transition-colors">
          <svg id="play-icon" class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
          <svg id="pause-icon" class="w-3 h-3 hidden" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
        </button>

        <div class="w-32 h-[1px] bg-white/10 relative">
          <div id="audio-progress" class="absolute top-0 left-0 h-full bg-white/40 transition-all" style="width: 0%"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="legend">
    <div class="legend-item"><div class="legend-color" style="background: #fb7185; color: #fb7185;"></div> A jouÃ© avec / scÃ¨ne</div>
    <div class="legend-item"><div class="legend-color" style="background: #fde047; color: #fde047;"></div> Influence / filiation</div>
  </div>

  <svg id="viz" class="w-full h-screen"></svg>

  <script>
    (function(){
      const write = (msg) => {
        const el = document.getElementById("load-status");
        if (el) el.textContent = msg;
      };
      window.addEventListener("error", (e) => {
        write(`Erreur JS: ${e.message || "unknown"}`);
      });
      window.addEventListener("unhandledrejection", (e) => {
        const msg = (e && e.reason && (e.reason.message || String(e.reason))) ? (e.reason.message || String(e.reason)) : "unknown";
        write(`Promise rejetÃ©e: ${msg}`);
      });
    })();

    window.addEventListener("DOMContentLoaded", () => {
      const GRAPH_JSON_URL = "./metal.json";

      const NODE_BLUE = "#f97316";
      const relationCategoryColors = {
        "enseignement": "#fbbf24",
        "collaboration": "#fb7185",
      };

      function linkCategory(d){
        const rel = (d && (d.relation || d.property || d.type)) ? String(d.relation || d.property || d.type) : "";
        const relNorm = rel.toLowerCase();

        if (relNorm.includes("Ã©lÃ¨ve") || relNorm.includes("enseignement") || relNorm.includes("appris") || relNorm.includes("formÃ©") || relNorm.includes("enseigne")) {
          return "enseignement";
        }
        if (relNorm.includes("p1066") || relNorm.includes("p802") || relNorm.includes("learned") || relNorm.includes("taught")) {
          return "enseignement";
        }
        return "collaboration";
      }

      function linkColor(d){
        const cat = linkCategory(d);
        return relationCategoryColors[cat] || "#94a3b8";
      }

      function parseYear(wdTime) {
        if (!wdTime || typeof wdTime !== "string") return null;
        const m = wdTime.match(/^[+-]?(\d{4})-/);
        return m ? Number(m[1]) : null;
      }

      function labelFromNode(n) {
        return (n && n.name) ? n.name : (n && n.id) ? n.id : "Unknown";
      }

      function wikiTitleFromNode(n) {
        const url = n && n.wikipedia;
        if (url && typeof url === "string") {
          try {
            const parts = url.split("/wiki/");
            if (parts.length === 2) return decodeURIComponent(parts[1]);
          } catch {}
        }
        return labelFromNode(n);
      }

      function fnv1a32(str){
        str = String(str || "");
        let h = 0x811c9dc5;
        for (let i = 0; i < str.length; i++){
          h ^= str.charCodeAt(i);
          h = Math.imul(h, 0x01000193);
        }
        return (h >>> 0);
      }

      let width = window.innerWidth, height = window.innerHeight;
      const svg = d3.select("#viz").attr("width", width).attr("height", height).attr("viewBox", `0 0 ${width} ${height}`);
      const g = svg.append("g");

      let currentNodes = [];
      let currentLinks = [];
      let currentSelectedId = null;

      const zoom = d3.zoom().scaleExtent([0.1, 2]).on("zoom", (e) => g.attr("transform", e.transform));
      svg.call(zoom).on("dblclick.zoom", null);

      let xStrengthGlobal = 4.2;
      let xRangeStartGlobal = 240;
      let xRangeFactorGlobal = 7.2;

      let timeScale = d3.scaleLinear().domain([1670, 1900]).range([xRangeStartGlobal, width * xRangeFactorGlobal]);

      const simulation = d3.forceSimulation()
        .force("link", d3.forceLink().id(d => d.id).distance(310).strength(0.010))
        .force("charge", d3.forceManyBody().strength(-280))
        .force("x", d3.forceX(d => timeScale(d.birthYear)).strength(xStrengthGlobal))
        .force("y", d3.forceY(height / 2).strength(0.045))
        .force("collide", d3.forceCollide(d => d.isSun ? 64 : 32).strength(0.55))
        .alphaDecay(0.035)
        .velocityDecay(0.68)
        .on("tick", ticked);

      let linkGroup = g.append("g").selectAll(".link-container");
      let nodeGroup = g.append("g").selectAll(".node");

      let linkBGSel = null;
      let linkMainSel = null;
      let linkTextPathSel = null;
      let nodeTransformSel = null;

    function edgeKey(d){
    const s = (d.source && d.source.id) ? d.source.id : d.source;
    const t = (d.target && d.target.id) ? d.target.id : d.target;
    return `${s}â†’${t}â†’${d.property || ""}â†’${d.direction || ""}â†’${d.via_id || d.via || ""}`;
    }

    // âœ… id uniques garantis (pas de collision)
    const edgeIdByKey = new Map();
    let edgeIdSeq = 0;
    function edgeId(d){
    const k = edgeKey(d);
    if (!edgeIdByKey.has(k)) edgeIdByKey.set(k, `edgepath-${++edgeIdSeq}`);
    return edgeIdByKey.get(k);
    }

      function linkTouchesSelected(d){
        if (!currentSelectedId) return false;
        const s = (d.source && d.source.id) ? d.source.id : d.source;
        const t = (d.target && d.target.id) ? d.target.id : d.target;
        return (s === currentSelectedId || t === currentSelectedId);
      }

      let __rafPending = false;
      function ticked() {
        if (__rafPending) return;
        __rafPending = true;
        requestAnimationFrame(() => {
          __rafPending = false;

          if (linkBGSel && linkMainSel && linkTextPathSel) {
            linkBGSel.attr("d", linkArcD);
            linkMainSel.attr("d", linkArcD);
            linkTextPathSel.attr("d", linkTextD);
          }

          if (nodeTransformSel) {
            nodeTransformSel.attr("transform", d => `translate(${d.x},${d.y})`);
          }
        });
      }

      function linkArcD(d){
        if (!d.source || !d.target || typeof d.source.x !== "number" || typeof d.target.x !== "number") return "M0,0L0,0";
        const sx = d.source.x, sy = d.source.y;
        const tx = d.target.x, ty = d.target.y;
        const dx = tx - sx, dy = ty - sy;
        const dr = Math.sqrt(dx * dx + dy * dy) * 1.55;
        return `M${sx},${sy}A${dr},${dr} 0 0,1 ${tx},${ty}`;
      }

        function linkTextD(d){
        if (!d.source || !d.target || typeof d.source.x !== "number" || typeof d.target.x !== "number") return "M0,0L0,0";

        let sx = d.source.x, sy = d.source.y;
        let tx = d.target.x, ty = d.target.y;

        const dx0 = tx - sx, dy0 = ty - sy;
        const dr = Math.sqrt(dx0 * dx0 + dy0 * dy0) * 1.55;

        // âœ… si on inverse les points pour lecture Lâ†’R, on inverse aussi le sweep
        let sweep = 1;
        if (tx < sx) {
            const _x = sx, _y = sy;
            sx = tx; sy = ty;
            tx = _x; ty = _y;
            sweep = 0; // <â€”â€” important
        }

        return `M${sx},${sy}A${dr},${dr} 0 0,${sweep} ${tx},${ty}`;
        }


      const fullDatabase = { nodes: [], links: [] };
      const nodeById = new Map();

      let searchIndex = [];
      const normStr = (s) => String(s || "")
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/['â€™`]/g, "")
        .replace(/[^a-z0-9\s-]/g, " ")
        .replace(/\s+/g, " ")
        .trim();

      function buildSearchIndex(){
        searchIndex = fullDatabase.nodes.map(n => ({
          id: n.id,
          label: n.label || n.name || n.id,
          norm: normStr(n.label || n.name || n.id)
        }));
        searchIndex.sort((a,b) => a.label.localeCompare(b.label, "fr", { sensitivity: "base" }));
      }

      function initSearchUI(){
        const input = document.getElementById("search-input");
        const box = document.getElementById("search-results");
        if (!input || !box) return;

        let activeIdx = -1;
        let lastResults = [];

        const hide = () => { box.style.display = "none"; box.innerHTML = ""; activeIdx = -1; lastResults = []; };
        const show = (items) => {
          lastResults = items;
          box.innerHTML = "";
          if (!items.length) { hide(); return; }
          items.forEach((it, idx) => {
            const row = document.createElement("div");
            row.className = "sr-item" + (idx === activeIdx ? " active" : "");
            row.innerHTML = `<span>${it.label}</span><small>${it.id}</small>`;
            row.onmouseenter = () => { activeIdx = idx; refreshActive(); };
            row.onclick = () => {
              const node = nodeById.get(it.id);
              if (node) {
                hide();
                input.blur();
                selectComposer(node);
              }
            };
            box.appendChild(row);
          });
          box.style.display = "block";
        };

        const refreshActive = () => {
          const kids = Array.from(box.children);
          kids.forEach((el, i) => el.classList.toggle("active", i === activeIdx));
        };

        const search = (q) => {
          const nq = normStr(q);
          if (!nq || nq.length < 2) return [];
          const res = [];
          for (const it of searchIndex) {
            const pos = it.norm.indexOf(nq);
            if (pos === -1) continue;
            const score = (pos === 0 ? 0 : 10) + it.norm.length;
            res.push({ ...it, _score: score });
            if (res.length > 60) break;
          }
          res.sort((a,b) => a._score - b._score);
          return res.slice(0, 10);
        };

        input.addEventListener("input", () => {
          activeIdx = -1;
          show(search(input.value));
        });

        input.addEventListener("keydown", (e) => {
          if (e.key === "Escape") { hide(); return; }
          if (!lastResults.length) return;

          if (e.key === "ArrowDown") {
            e.preventDefault();
            activeIdx = Math.min(lastResults.length - 1, activeIdx + 1);
            refreshActive();
          } else if (e.key === "ArrowUp") {
            e.preventDefault();
            activeIdx = Math.max(0, activeIdx - 1);
            refreshActive();
          } else if (e.key === "Enter") {
            e.preventDefault();
            const pick = lastResults[Math.max(0, activeIdx)];
            if (pick) {
              const node = nodeById.get(pick.id);
              if (node) { hide(); input.blur(); selectComposer(node); }
            }
          }
        });

        document.addEventListener("click", (e) => {
          const t = e.target;
          if (!t) return;
          if (t === input || box.contains(t)) return;
          hide();
        });
      }

      function setCenter(centerId){
        const centerRaw = nodeById.get(centerId);
        if (!centerRaw) return;

        const visited = new Set([centerId]);
        let frontier = new Set([centerId]);

        for (let depth = 0; depth < 2; depth++) {
          const next = new Set();
          for (const l of fullDatabase.links) {
            const srcId = (l.source && l.source.id) ? l.source.id : l.source;
            const tgtId = (l.target && l.target.id) ? l.target.id : l.target;

            if (frontier.has(srcId) && !visited.has(tgtId)) next.add(tgtId);
            if (frontier.has(tgtId) && !visited.has(srcId)) next.add(srcId);
          }
          next.forEach(v => visited.add(v));
          frontier = next;
        }

        const centerY = height / 2;
        const centerX = timeScale(centerRaw.birthYear || timeScale.domain()[0]);

        currentNodes = [];
        currentLinks = [];

        visited.forEach(vid => {
          const data = nodeById.get(vid);
          if (!data) return;
          const isCenter = (vid === centerId);
          data.x = isCenter ? centerX : timeScale(data.birthYear || timeScale.domain()[0]);
          data.y = centerY + (Math.random() - 0.5) * (isCenter ? 1 : 380);
          currentNodes.push(data);
        });

        for (const l of fullDatabase.links) {
          const srcId = (l.source && l.source.id) ? l.source.id : l.source;
          const tgtId = (l.target && l.target.id) ? l.target.id : l.target;
          if (visited.has(srcId) && visited.has(tgtId)) {
            currentLinks.push({
              source: srcId,
              target: tgtId,
              relation: l.relation,
              direction: l.direction,
              property: l.property,
              via: l.via,
              via_id: l.via_id
            });
          }
        }

        updateViz();
        simulation.alpha(0.75).restart();
      }

      let minYearGlobal = 1670;
      let maxYearGlobal = 1900;

      function onResize(){
        width = window.innerWidth;
        height = window.innerHeight;

        svg.attr("width", width).attr("height", height).attr("viewBox", `0 0 ${width} ${height}`);
        timeScale.range([xRangeStartGlobal, width * xRangeFactorGlobal]);

        simulation.force("x", d3.forceX(d => timeScale(d.birthYear)).strength(xStrengthGlobal));
        simulation.force("y", d3.forceY(height / 2).strength(0.045));

        drawTimeline(minYearGlobal, maxYearGlobal);
        simulation.alpha(0.25).restart();
      }

      window.addEventListener("resize", () => {
        clearTimeout(window.__moz_resize_t);
        window.__moz_resize_t = setTimeout(onResize, 120);
      });

      function updateViz() {
        const defs = svg.select("defs").size() ? svg.select("defs") : svg.append("defs");

        if (!document.getElementById("grad-blue")) {
          const grad = defs.append("radialGradient").attr("id", "grad-blue");
          grad.append("stop").attr("offset", "0%").attr("stop-color", NODE_BLUE).attr("stop-opacity", 1);
          grad.append("stop").attr("offset", "100%").attr("stop-color", d3.color(NODE_BLUE).darker(2)).attr("stop-opacity", 0.4);
        }

        linkGroup = linkGroup
          .data(currentLinks, d => edgeKey(d))
          .join(enter => {
            const sel = enter.append("g").attr("class", "link-container")
              .on("click", (e, d) => {
                const srcId = d.source.id || d.source;
                const tgtId = d.target.id || d.target;
                const nextNodeId = (srcId === currentSelectedId) ? tgtId : srcId;
                const nextNode = currentNodes.find(n => n.id === nextNodeId) || nodeById.get(nextNodeId);
                if (nextNode) selectComposer(nextNode);
              });

            sel.append("path").attr("class", "link-bg");
            sel.append("path").attr("class", "link-main").attr("stroke", d => linkColor(d));

            sel.append("path")
              .attr("class", "link-text-path")
              .attr("id", d => edgeId(d))
              .attr("fill", "none")
              .attr("stroke", "none");

            sel.append("text")
              .attr("class", "link-label")
              .attr("dy", -2)
              .append("textPath")
              .attr("href", d => `#${edgeId(d)}`)
              .attr("startOffset", "50%")
              .attr("text-anchor", "middle")
              .text(""); // âœ… initially empty; filled only for selected node links

            return sel;
          });

        // âœ… keep strokes updated
        linkGroup.selectAll(".link-main").attr("stroke", d => linkColor(d));

        // âœ… ONLY show group name (via) for links touching selected node
        linkGroup.selectAll(".link-label textPath")
          .text(d => {
            if (!linkTouchesSelected(d)) return "";
            return (linkCategory(d) === "collaboration" && d.via) ? String(d.via) : "";
          });

        // âœ… position: closer to selected node, centered for others (but others have empty text anyway)
        linkGroup.selectAll(".link-label textPath")
          .attr("startOffset", d => linkTouchesSelected(d) ? "28%" : "50%")
          .attr("text-anchor", d => linkTouchesSelected(d) ? "start" : "middle");

        linkGroup.selectAll(".link-label")
          .attr("dy", d => linkTouchesSelected(d) ? -4 : -2);

        nodeGroup = nodeGroup.data(currentNodes, d => d.id)
          .join(enter => {
            const sel = enter.append("g").attr("class", "node")
              .on("click", (e, d) => selectComposer(d));

            sel.append("circle")
              .attr("r", d => d.isSun ? 35 : 18)
              .attr("fill", "url(#grad-blue)");

            sel.append("text")
              .attr("dy", d => d.isSun ? 55 : 35)
              .attr("text-anchor", "middle")
              .attr("class", "label")
              .text(d => d.label);

            return sel;
          });

        nodeGroup.classed("selected", n => n.id === currentSelectedId);

        // âœ… cache selections for tick (perf)
        linkBGSel = linkGroup.select(".link-bg");
        linkMainSel = linkGroup.select(".link-main");
        linkTextPathSel = linkGroup.select(".link-text-path");
        nodeTransformSel = nodeGroup;

        simulation.nodes(currentNodes);
        simulation.force("link").links(currentLinks);
      }

      let timelineLayer = null;
      function drawTimeline(minYear, maxYear) {
        if (timelineLayer) timelineLayer.remove();
        timelineLayer = g.append("g").attr("class", "timeline-layer");

        const span = maxYear - minYear;
        const step = Math.max(10, span > 80 ? 10 : 5);
        const start = Math.floor(minYear / step) * step;
        const end = Math.ceil(maxYear / step) * step;

        const years = [];
        for (let y = start; y <= end; y += step) years.push(y);

        timelineLayer.selectAll(".timeline-axis").data(years).join("line").attr("class", "timeline-axis")
          .attr("x1", d => timeScale(d)).attr("x2", d => timeScale(d)).attr("y1", 0).attr("y2", height);

        timelineLayer.selectAll(".timeline-label").data(years).join("text").attr("class", "timeline-label")
          .attr("x", d => timeScale(d) + 10).attr("y", height - 40).text(d => d);
      }

      let currentAudio = null;

      function centerOnNodeById(nodeId, scale = 1.1, duration = 1400) {
        const live = currentNodes.find(n => n.id === nodeId) || nodeById.get(nodeId);
        if (!live) return;

        const x = (typeof live.x === "number" && isFinite(live.x)) ? live.x : (width / 2);
        const y = (typeof live.y === "number" && isFinite(live.y)) ? live.y : (height / 2);

        const t = d3.zoomIdentity
          .translate(width / 2 - x * scale, height / 2 - y * scale)
          .scale(scale);

        svg.transition()
          .duration(duration)
          .ease(d3.easePolyOut.exponent(3))
          .call(zoom.transform, t);
      }

      async function selectComposer(d) {
        const target = d;
        currentSelectedId = target.id;

        nodeGroup.classed("selected", n => n.id === target.id);

        setCenter(target.id);
        requestAnimationFrame(() => centerOnNodeById(target.id, 1.1, 1400));

        const card = document.getElementById("bio-card");
        card.style.display = "block";

        document.getElementById("bio-name").innerText = target.label;

        const by = target.birthYear ?? "â€”";
        const dy = target.deathYear ?? "â€”";
        document.getElementById("bio-dates").innerText = `${by} â€” ${dy}`;

        fetchWiki(target._raw || target, target.label);
        playPreview(target.label);
      }

      async function fetchWiki(nodeOrRaw, fallbackLabel) {
        try {
          const title = wikiTitleFromNode(nodeOrRaw) || fallbackLabel;
          const res = await fetch(`https://fr.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`);
          const wiki = await res.json();

          document.getElementById("bio-desc").innerText = wiki.extract || "";

          const img = document.getElementById("bio-image");
          if (wiki.thumbnail) {
            img.src = wiki.thumbnail.source;
            img.style.display = "block";
          } else if (nodeOrRaw && nodeOrRaw.image) {
            img.src = nodeOrRaw.image;
            img.style.display = "block";
          } else {
            img.style.display = "none";
          }
        } catch(e) {}
      }

      async function itunesSearch(term, attribute, limit = 25) {
        const base = `https://itunes.apple.com/search?term=${encodeURIComponent(term)}&entity=musicTrack&limit=${limit}`;
        const url = attribute ? `${base}&attribute=${attribute}` : base;
        const res = await fetch(url);
        const json = await res.json();
        return json?.results ?? [];
      }

      async function playPreview(name) {
        if (currentAudio) {
          const oldAudio = currentAudio;
          let vol = oldAudio.volume;
          const interval = setInterval(() => {
            vol = Math.max(0, vol - 0.05);
            oldAudio.volume = vol;
            if (vol <= 0) {
              oldAudio.pause();
              clearInterval(interval);
            }
          }, 50);
        }

        const player = document.getElementById("music-player");
        if (!player) return;

        if (!name || typeof name !== "string") {
          player.style.display = "none";
          currentAudio = null;
          return;
        }

        try {
          let results = await itunesSearch(name, "composerTerm", 25);
          let candidates = (results || []).filter(r => !!r.previewUrl);

          let pick = candidates[0];
          let mode = "composerTerm";

          if (!pick) {
            results = await itunesSearch(name, null, 80);
            candidates = (results || []).filter(r => !!r.previewUrl);
            pick = candidates[0];
            mode = "fallback";
          }

          if (!pick) {
            player.style.display = "none";
            currentAudio = null;
            return;
          }

          player.style.display = "block";

          const trackEl = document.getElementById("player-track");
          if (trackEl) trackEl.innerText = (pick.trackName || "") + (pick.artistName ? ` â€” ${pick.artistName}` : "");

          const roleEl = document.getElementById("player-role");
          if (roleEl) {
            roleEl.innerText =
              (mode === "composerTerm")
                ? `Suggestion iTunes â€¢ RÃ©f : ${name} â€¢ InterprÃ¨te : ${pick.artistName || "â€”"}`
                : `Suggestion iTunes (fallback) â€¢ RÃ©f : ${name} â€¢ InterprÃ¨te : ${pick.artistName || "â€”"}`;
          }

          currentAudio = new Audio(pick.previewUrl);
          currentAudio.volume = 0;

          await currentAudio.play();

          let vol = 0;
          const fadeIn = setInterval(() => {
            vol = Math.min(0.35, vol + 0.02);
            if (currentAudio) currentAudio.volume = vol;
            if (vol >= 0.35) clearInterval(fadeIn);
          }, 100);

          document.getElementById("pause-icon")?.classList.remove("hidden");
          document.getElementById("play-icon")?.classList.add("hidden");

          currentAudio.ontimeupdate = () => {
            const dur = currentAudio?.duration || 0;
            const progress = dur ? (currentAudio.currentTime / dur) * 100 : 0;
            const bar = document.getElementById("audio-progress");
            if (bar) bar.style.width = progress + "%";
          };

        } catch (e) {
          console.error("playPreview failed:", e);
          player.style.display = "none";
          currentAudio = null;
        }
      }

      (function(){
        const btn = document.getElementById("play-pause-btn");
        if (!btn) return;
        btn.onclick = () => {
          if (!currentAudio) return;
          if (currentAudio.paused) {
            currentAudio.play();
            document.getElementById("pause-icon")?.classList.remove("hidden");
            document.getElementById("play-icon")?.classList.add("hidden");
          } else {
            currentAudio.pause();
            document.getElementById("pause-icon")?.classList.add("hidden");
            document.getElementById("play-icon")?.classList.remove("hidden");
          }
        };
      })();

      async function loadGraph() {
        const status = document.getElementById("load-status");
        status.textContent = "Chargement du grapheâ€¦";

        const res = await fetch(GRAPH_JSON_URL);
        if (!res.ok) throw new Error(`Fetch ${GRAPH_JSON_URL} â†’ HTTP ${res.status}`);
        const graph = await res.json();

        status.textContent = "PrÃ©parationâ€¦";

        const rawNodes = graph.nodes || [];
        fullDatabase.nodes = rawNodes
          .map(n => {
            const by = parseYear(n.birth);
            if (by == null) return null; // drop unknown birth year
            const dy = parseYear(n.death);
            const converted = {
              id: n.id,
              label: labelFromNode(n),
              birthYear: by,
              deathYear: dy ?? null,
              isSun: n.id === graph.center,
              _raw: n
            };
            nodeById.set(converted.id, converted);
            return converted;
          })
          .filter(Boolean);

        const keptIds = new Set(fullDatabase.nodes.map(n => n.id));

        const rawEdges = graph.edges || [];
        fullDatabase.links = rawEdges
          .filter(e => keptIds.has(e.source) && keptIds.has(e.target))
          .map(e => ({
            source: e.source,
            target: e.target,
            property: e.property,
            relation: e.relation,
            direction: e.direction,
            via: e.via || e.group || null,
            via_id: e.via_id || e.group_id || null
          }));

        (function dedupeLinks(){
          const seen = new Map();
          const out = [];
          for (const e of fullDatabase.links){
            const a = String(e.source);
            const b = String(e.target);
            const k = (a < b) ? (a + "||" + b) : (b + "||" + a);
            if (seen.has(k)) continue;
            seen.set(k, true);
            out.push(e);
          }
          fullDatabase.links = out;
        })();

        const years = fullDatabase.nodes
          .map(n => n.birthYear)
          .filter(y => typeof y === "number" && isFinite(y));

        const minYear = Math.min(...years);
        const maxYear = Math.max(...years);

        timeScale = d3.scaleLinear()
          .domain([minYear, maxYear])
          .range([xRangeStartGlobal, width * xRangeFactorGlobal]);

        buildSearchIndex();
        initSearchUI();

        drawTimeline(minYear, maxYear);

        status.textContent = `OK â€” ${fullDatabase.nodes.length} nÅ“uds, ${fullDatabase.links.length} liens`;
      }

      const startBtn = document.getElementById("start-btn");
      const statusEl = document.getElementById("load-status");
      let __started = false;

      async function startExperience(e){
        if (__started) return;
        __started = true;

        if (statusEl) statusEl.textContent = "Startâ€¦";

        try { e && e.preventDefault && e.preventDefault(); } catch {}
        try { e && e.stopPropagation && e.stopPropagation(); } catch {}

        try {
          const unlock = new Audio();
          unlock.src = "data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAAAA==";
          try { await unlock.play(); } catch {}

          await loadGraph();

          document.getElementById("overlay").style.opacity = "0";
          setTimeout(() => {
            document.getElementById("overlay").style.display = "none";
            try { document.body.classList.remove("overlay-open"); } catch {}

            const gojira =
              fullDatabase.nodes.find(n => n.isSun) ||
              fullDatabase.nodes.find(n => /gojira/i.test(n.label || n.name || "")) ||
              fullDatabase.nodes[0];

            if (!gojira) return;
            setTimeout(() => selectComposer(gojira), 500);
          }, 2000);
        } catch (err) {
          console.error(err);
          if (statusEl) statusEl.textContent = `Erreur: ${(err && err.message) ? err.message : String(err)}`;
          __started = false;
        }
      }

      if (!startBtn) {
        if (statusEl) statusEl.textContent = "Erreur: bouton #start-btn introuvable";
      } else {
        startBtn.addEventListener("click", startExperience, { passive: false });
        startBtn.addEventListener("touchend", startExperience, { passive: false });
        startBtn.addEventListener("touchstart", startExperience, { passive: false });
      }
    });
  </script>

  <div id="info-btn" title="Ã€ propos"
    style="
      position: fixed;
      bottom: 10px;
      right: 18px;
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(2,6,23,0.55);
      backdrop-filter: blur(12px);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 2500;
      color: rgba(255,255,255,0.45);
      font-family: serif;
      font-style: italic;
      transition: all 0.4s ease;
      user-select: none;
    ">i</div>

  <div id="info-panel"
    style="
      position: fixed;
      bottom: 62px;
      right: 18px;
      width: min(360px, calc(100vw - 36px));
      background: rgba(2,6,23,0.72);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 18px;
      padding: 16px 18px;
      backdrop-filter: blur(18px);
      z-index: 2500;
      display: none;
      animation: fadeIn 0.6s ease;
    ">

    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h3 style="font-size:12px;letter-spacing:0.12em;text-transform:uppercase;color:rgba(255,255,255,0.65);margin:0;">
        Ã€ propos
      </h3>

      <button id="info-close" aria-label="Fermer"
        style="background:none;border:none;color:rgba(255,255,255,0.35);cursor:pointer;font-size:14px;">âœ•</button>
    </div>

    <p style="margin-top:10px;font-size:12px;line-height:1.5;color:rgba(255,255,255,0.55);font-style:italic;">
      Ce graphe a Ã©tÃ© construit Ã  partir de <b>Devin Townsend</b>, en explorant rÃ©cursivement
      sur Wikidata les relations de <i>collaboration musicale</i> :
      artistes ayant <i>jouÃ© ou chantÃ© ensemble</i>, ainsi que quelques liens
      dâ€™<i>apprentissage</i> et de <i>transmission</i>.
    </p>

    <p style="margin-top:8px;font-size:11px;color:rgba(255,255,255,0.45);letter-spacing:0.08em;text-transform:uppercase;">
      2696 nÅ“uds â€¢ 15700 arcs
    </p>

    <p style="margin-top:10px;font-size:11px;color:rgba(255,255,255,0.40);">
      Mesure dâ€™audience anonyme via <b>Cloudflare Analytics</b>, sans cookies.
    </p>
  </div>

  <script>
    (function(){
      const infoBtn = document.getElementById("info-btn");
      const infoPanel = document.getElementById("info-panel");
      const infoClose = document.getElementById("info-close");
      if (!infoBtn || !infoPanel || !infoClose) return;

      function toggle(force){
        if (force === true) infoPanel.style.display = "block";
        else if (force === false) infoPanel.style.display = "none";
        else infoPanel.style.display = (infoPanel.style.display === "block") ? "none" : "block";
      }

      infoBtn.addEventListener("click", (e) => { e.stopPropagation(); toggle(); }, { passive: true });
      infoClose.addEventListener("click", (e) => { e.stopPropagation(); toggle(false); }, { passive: true });

      document.addEventListener("click", (e) => {
        if (infoPanel.style.display !== "block") return;
        if (!infoPanel.contains(e.target) && e.target !== infoBtn) toggle(false);
      });
    })();
  </script>
</body>
</html>
